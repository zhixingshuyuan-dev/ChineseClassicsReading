<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>《西游记》辅助阅读器</title>
  <style>
    body {
      font-family: 'Noto Serif SC', serif;
      background-color: #f9f9f9;
      color: #333;
      margin: 0;
      padding: 1em;
      line-height: 1.8;
    }
    .line {
      margin-bottom: 1.5em;
      font-size: 1.2em;
    }
    .char {
      cursor: pointer;
      padding: 0.2em;
      border-radius: 0.3em;
      transition: background 0.3s;
    }
    .char:hover {
      background-color: #eee;
    }
    .annotation {
      display: block;
      font-size: 0.9em;
      color: #666;
    }
    .controls {
      margin-top: 0.5em;
    }
    button {
      margin-right: 0.5em;
      padding: 0.4em 0.8em;
      font-size: 0.9em;
      border: none;
      border-radius: 0.4em;
      background-color: #007BFF;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    @media (max-width: 600px) {
      body {
        font-size: 1em;
        padding: 0.5em;
      }
      .controls button {
        display: block;
        margin-top: 0.4em;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <h1>《西游记》第四回 辅助阅读</h1>
  <div id="content"></div>

  <script>
    const data = `那太白金星与美猴王 同出了洞天深处 一齐驾云而起 原来悟空筋斗云比众不同 十分快疾 把个金星撇在脑后 先至南天门外 正欲收云前进 被增长天王领着庞刘苟毕邓辛张陶 一路大力天丁 枪刀剑戟 挡住天门 不肯放进 猴王道 这个金星老儿 乃奸诈之徒 既请老孙 如何教人动刀动枪 阻塞门路 正嚷间 金星倏到 悟空就觌面发狠道 你这老儿 怎么哄我 被你说奉玉帝招安旨意来请 却怎么教这些人阻住天门 不放老孙进去 金星笑道 大王息怒 你自来未曾到此天堂 却又无名 众天丁又与你素不相识 他怎肯放你擅入 等如今见了天尊 授了仙录 注了官名 向后随你出入 谁复挡也 悟空道 这等说 也罢 我不进去了 金星又用手扯住道 你还同我进去`;

    const pinyinMap = {
      "太": "tài", "白": "bái", "金": "jīn", "星": "xīng", "悟": "wù", "空": "kōng",
      "筋": "jīn", "斗": "dǒu", "云": "yún", "南": "nán", "天": "tiān", "门": "mén",
      "猴": "hóu", "王": "wáng", "道": "dào", "你": "nǐ", "我": "wǒ", "不": "bù",
      "进": "jìn", "去": "qù", "请": "qǐng", "老": "lǎo", "孙": "sūn", "名": "míng",
      // ... 添加更多拼音数据
    };

    const englishMap = {
      "太": "great", "白": "white", "金": "gold", "星": "star", "悟": "awaken", "空": "emptiness",
      "筋": "muscle", "斗": "fight", "云": "cloud", "南": "south", "天": "heaven", "门": "gate",
      "猴": "monkey", "王": "king", "道": "say", "你": "you", "我": "I/me", "不": "not",
      "进": "enter", "去": "go", "请": "invite", "老": "old", "孙": "Sun (name)", "名": "name",
      // ... 添加更多英文释义
    };

    const translations = {
      en: "English", de: "Deutsch", fr: "Français", ja: "日本語", ko: "한국어", vi: "Tiếng Việt",
      it: "Italiano", es: "Español", pt: "Português", la: "Latina", el: "Ελληνικά", sa: "संस्कृतम्"
    };

    const contentEl = document.getElementById('content');
    let clickState = {};

    function renderText(text) {
      const lines = text.split(/(?<=\s)/);
      lines.forEach(line => {
        const div = document.createElement('div');
        div.className = 'line';
        line.split('').forEach(char => {
          if (char.trim()) {
            const span = document.createElement('span');
            span.className = 'char';
            span.textContent = char;
            span.dataset.char = char;
            span.dataset.state = 0;
            span.addEventListener('click', handleCharClick);
            div.appendChild(span);
          } else {
            div.appendChild(document.createTextNode(' '));
          }
        });
        const controls = document.createElement('div');
        controls.className = 'controls';
        const speakBtn = document.createElement('button');
        speakBtn.textContent = '🔊 朗读 / Read';
        speakBtn.onclick = () => speak(line);
        controls.appendChild(speakBtn);

        const translateBtn = document.createElement('button');
        translateBtn.textContent = '🌐 翻译 / Translate';
        translateBtn.onclick = () => translateLine(line);
        controls.appendChild(translateBtn);

        div.appendChild(controls);
        contentEl.appendChild(div);
      });
    }

    function handleCharClick(e) {
      const span = e.target;
      const char = span.dataset.char;
      let state = parseInt(span.dataset.state);
      state = (state + 1) % 3;
      span.dataset.state = state;

      if (state === 1) {
        span.innerHTML = `${char}<span class="annotation">${pinyinMap[char] || ''}</span>`;
      } else if (state === 2) {
        speak(char);
      } else {
        span.innerHTML = `${char}<span class="annotation">${englishMap[char] || ''}</span>`;
      }
    }

    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'zh-CN';
      utterance.voice = speechSynthesis.getVoices().find(v => v.lang === 'zh-CN' && v.name.includes('男')) || null;
      speechSynthesis.speak(utterance);
    }

    async function translateLine(text) {
      const apiKey = 'YOUR_API_KEY'; // 需要替换为你自己的翻译 API Key
      for (const [lang, label] of Object.entries(translations)) {
        const res = await fetch(`https://translation.googleapis.com/language/translate/v2?key=${apiKey}`, {
          method: 'POST',
          body: JSON.stringify({
            q: text,
            target: lang
          }),
          headers: { 'Content-Type': 'application/json' }
        });
        const json = await res.json();
        alert(`${label}：${json.data.translations[0].translatedText}`);
      }
    }

    renderText(data);
  </script>
</body>
</html>
